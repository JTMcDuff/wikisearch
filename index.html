<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Wikisearch</title>
  </head>
  <body>
  	<header>
  		<h1>Wikisearch</h1>
  		<form>
	  		<input type="text" id="search-input" name="Search Wikipedia" value="Search Me">
	  		<button type="button" name="Search Button" onclick="searchWiki()">
	  			Search
	  		</button>
  		</form>
  	</header>

  	<main>
  		<h2> Search Results</h2>

  		<div id="search-results"></div>
			<!-- <div>
				<span>
					<a href="http://en.wikipedia.org/?curid=17297685" target="_blank">Test!</a>
					<p>wordcount: 1043></p>
				</span>
				<p>Snippet: "sufficing in Bible situations and chapters; and Hudson commented on &quot;<span class="searchmatch">Search</span> <span class="searchmatch">Me</span>&quot;: &quot;I was struggling with the fact that I would have the huge responsibility" </p>
			</div>
 -->
  		</div>

  	</main>


  </body>

  <script>
  	// Init list store for easier sorting later.
  	let = wikiResults = [];

  	// *** INPUT AND DOM FUNCTIONS ***

  	/**
  	* @function handles searching and processing wikipedia
  	*/
  	function searchWiki() {
  		let searchTerm = getSearchTerm();
  		makeWikiAPICall(searchTerm)
  		.then(results =>{
  			let formattedResults = formatResults(results);
  			renderResults(formattedResults);
  		}).catch(error => {
  			alert('Something went wrong ', error);
  		});
  	};

  	/*
  	* @function -- Gets search term fron input box and clears input.
  	* @returns -- string from search input
  	*/
  	function getSearchTerm() {
  		var searchTerm = document.getElementById('search-input').value;
  		document.getElementById('search-input').value = '';
  		
  		return searchTerm;
  	};

  	/**
  	 * @function -- formats JSON from wikipedia
	 * @inputs -- JSON from wikipedia search
	 * @returns -- array of html objects
	*/
  	function formatResults(results) {
  		let node;
		let searchInfo = results.query.searchinfo;
		let searchResults = results.query.search;
		let resultArray = searchResults.map(result =>{
			return formatResult(result);
		});
		
		//document.getElementById('search-results').appendChild(resultDiv);
		return resultArray;
  	};

  	/**
  	 * @ function -- formats an individual result into html
  	 * @ inputs -- an object of a single search result
  	 * @ returns -- formatted html
	*/
  	function formatResult(result) {
  		let resultDiv = document.createElement('div');
		let titleSpan = document.createElement('span');
		
		let wordCount = document.createElement('p');
		wordCount.innerHTML = 'Wordcount: ' + result.wordcount;

		let pageLink = document.createElement('a');
		pageLink.setAttribute('href', 'http://en.wikipedia.org/?curid=' + result.pageid);
		pageLink.target = '_blank';
		pageLink.text = result.title;

		let snippet = document.createElement('p');
		snippet.innerHTML = 'Snippet: ' + result.snippet;

		titleSpan.appendChild(pageLink);
		titleSpan.appendChild(wordCount);
		resultDiv.appendChild(titleSpan);
		resultDiv.appendChild(snippet);

		return resultDiv;
  	};

  	/**
  	Data Example:
		ns: 0
        pageid: 17297685
        size: 18603
        snippet: "sufficing in Bible situations and chapters; and Hudson commented on &quot;<span class="searchmatch">Search</span> <span class="searchmatch">Me</span>&quot;: &quot;I was struggling with the fact that I would have the huge responsibility"
        timestamp: "2018-12-27T15:36:09Z"
        title: "Katy Hudson (album)"
  	*/

  	/**
  	 * @function -- renders results onto DOM
	 * @inputs -- formatted array
	*/
  	function renderResults(results) {
  		var resultTarget = document.getElementById('search-results');
  		results.forEach(result => {
  			resultTarget.appendChild(result);
  		})	
  	};

  	// *** END INPUT AND DOM FUNCTIONS ***

  	// *** API AND PROCESSING FUNCTIONS ***

  	/**
  	 * @function -- makes API call to wikipedia
	 * @inputs -- string search term
	 * @returns -- promise object with parsed json
	*/
  	function makeWikiAPICall(searchTerm) {
		return fetch(constructURL(searchTerm), {
		    method: 'GET',
		    headers:{
	        	'Content-Type': 'application/json'
	      	}
		})
		.then(response =>{
			return response.json();
		})
		.then(resJson =>{
			return resJson;
		})
		.catch(error => {
			// TODO JOHNNY: Update with more effective error handling.
			console.log(error);
			return error;
		});
  	};

  	/**
  	 * @function -- constructs URL for service call
	 * @inputs -- string search term
	 * @returns -- URL object ready for fetch
	*/
  	function constructURL(searchTerm) {
  		// Designed for future expansion
		let url = new URL('https://en.wikipedia.org/w/api.php'),
    	params = {
    		'action': 'query',
    		'list':'search',
    		'srsearch': searchTerm,
    		'format':'json',
    		'origin': '*'
    	};
		Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
		console.log('My URL', url);
  		return url;
  	};

  	// *** END API AND PROCESSING FUNCTIONS ***

 
  </script>
</html>